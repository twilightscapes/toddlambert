---
import { getAllPosts, getUniqueTagsWithCount, sortMDByDate } from "@/data/post";
import PostPreview from "@/components/blog/PostPreview.astro";
import ViewModeSwitch from "@/components/ViewModeSwitch.jsx";
import { getEntry } from 'astro:content';

interface Props {
  sectionId?: string;
  title?: string;
  description?: string;
  showTitle?: boolean;
  hideCollapseButton?: boolean;
  defaultView?: 'grid' | 'swipe';
}

const { 
  sectionId = 'magic-search',
  title = 'Search Posts',
  description = '',
  showTitle = true,
  hideCollapseButton = false,
  defaultView: propDefaultView
} = Astro.props;

const allPosts = await getAllPosts();
const sortedPosts = sortMDByDate(allPosts, true);
const tagsWithCount = getUniqueTagsWithCount(allPosts);

const siteSettings = await getEntry('siteSettings', 'main');
const defaultView = propDefaultView ?? siteSettings?.data?.defaultView ?? 'grid';
const MAX_POSTS = siteSettings?.data?.MAX_POSTS ?? 5;
---

<div data-section-id={sectionId}>
  {((showTitle && (title || description)) || !hideCollapseButton) && (
    <div class="section-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding: 0 3%;">
      <div style="flex: 1;">
        {showTitle && title && (
          <h2 class="posties glow text-[clamp(1.4rem,1.9vw,4rem)] shadow-text theme-accent" style={`margin: 0; margin-bottom: ${description ? '1rem' : '0'};`}>
            {title}
          </h2>
        )}
        {showTitle && description && (
          <p style="font-size: 1.2rem; color: var(--theme-text); opacity: 0.8; margin: 0;">
            {description}
          </p>
        )}
      </div>
      <div class="section-controls" style="display: flex; align-items: center;">
        {!hideCollapseButton && (
          <button 
            class="section-collapse-toggle" 
            data-section={sectionId}
            style="background: var(--theme-surface, #333); border: none; border-radius: 4px; color: white; padding: 6px 12px; font-size: 18px; cursor: pointer;"
            title="Collapse/Expand Section">
            ▼
          </button>
        )}
      </div>
    </div>
  )}
  
  <!-- Search Controls -->
  <div class="search-controls" style="padding: 0 2rem 2rem; max-width: 1400px; margin: 0 auto;">
    <div class="search-filter-box" style="background: rgba(0, 0, 0, 0.3); padding: 1.5rem; border-radius: 0.75rem; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);">
      
      <!-- Search Bar -->
      <div class="search-bar-container" style="position: relative; margin-bottom: 1.25rem;">
        <input
          type="text"
          id={`${sectionId}-search-input`}
          placeholder="Search posts by title or description..."
          style="width: 100%; padding: 1.25rem 3.5rem 1.25rem 1.25rem; border-radius: 0.5rem; border: 2px solid var(--accent); background: rgba(0, 0, 0, 0.4); color: var(--textColor); font-size: 1.25rem; font-weight: 500;"
        />
        <button
          id={`${sectionId}-clear-search`}
          style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); padding: 0.5rem; background: transparent; border: none; cursor: pointer; display: none; color: var(--textColor);"
          aria-label="Clear search"
        >
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <!-- Tag Filter Pills -->
      <div class="tag-filter-container" style="margin-bottom: 0;">
        <div id={`${sectionId}-tag-pills-wrapper`} class="tag-pills-wrapper" style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; max-height: 2.5rem; overflow: hidden; transition: max-height 0.3s ease;">
          <span style="color: var(--textColor); font-weight: 600; padding-right: 0.5rem;">Topics:</span>
          <button
            class="tag-pill active"
            data-tag="all"
            data-section={sectionId}
            style="padding: 0.5rem 1rem; border-radius: 9999px; border: 2px solid var(--accent); background: var(--accent); color: white; cursor: pointer; font-weight: 600; transition: all 0.2s;"
          >
            All ({allPosts.length})
          </button>
          {tagsWithCount.map(([tag, count]) => (
            <button
              class="tag-pill"
              data-tag={tag}
              data-section={sectionId}
              style="padding: 0.5rem 1rem; border-radius: 9999px; border: 2px solid var(--accent); background: rgba(0, 0, 0, 0.5); color: var(--textColor); cursor: pointer; transition: all 0.2s;"
            >
              {tag} ({count})
            </button>
          ))}
        </div>
        {tagsWithCount.length > 5 && (
          <button
            id={`${sectionId}-toggle-tags`}
            style="margin-top: 0.75rem; padding: 0.25rem 0.75rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; color: var(--textColor); cursor: pointer; font-size: 0.875rem;"
          >
            Show More Tags ▼
          </button>
        )}
      </div>
      
    </div>
  </div>
  
  <!-- Results Count and View Toggle - Outside the dark box -->
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; max-width: 1400px; margin: 0 auto;">
    <div id={`${sectionId}-results-count`} style="color: var(--textColor); font-size: 0.875rem; opacity: 0.7;">
      Showing {Math.min(MAX_POSTS, allPosts.length)} of {allPosts.length} posts
    </div>
    {/* @ts-ignore - client:load is valid Astro directive */}
    <ViewModeSwitch 
      sectionId={sectionId}
      defaultView={defaultView}
      client:load
    />
  </div>
  
  <!-- Results Container - Using exact same structure as posts page -->
  <div class={`contentpanel section-content ${defaultView === 'swipe' ? 'slider' : 'grid-container'}`}>
    <div class="sliderSpacer"></div>
    {sortedPosts.map((post, index) => (
      <div 
        class="post-item" 
        data-section={sectionId}
        data-tags={JSON.stringify(post.data.tags)} 
        data-post-data={JSON.stringify({
          title: post.data.title,
          description: post.data.description,
          slug: post.slug
        })}
        style={index >= MAX_POSTS ? 'display: none;' : ''}
      >
        <PostPreview post={post} />
      </div>
    ))}
  </div>

  <!-- No Results Message -->
  <div id={`${sectionId}-no-results`} style="display: none; text-align: center; padding: 4rem 2rem; color: var(--textColor);">
    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1rem;">
      <circle cx="11" cy="11" r="8"/>
      <path d="M21 21l-4.35-4.35"/>
    </svg>
    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">No posts found</h3>
    <p>Try adjusting your search or filter criteria</p>
  </div>
</div>

<style>
  .tag-pill:hover {
    background: var(--accent) !important;
    color: white !important;
  }
  
  .tag-pill.active {
    background: var(--accent) !important;
    color: white !important;
  }
  
  [id$="-search-input"]:focus {
    outline: none;
    border-color: var(--link);
  }
  
  [id$="-clear-search"].visible {
    display: block !important;
  }
  
  .post-item {
    transition: opacity 0.3s, transform 0.3s;
  }
  
  .post-item.hidden {
    display: none;
  }
</style>

<script define:vars={{ MAX_POSTS, sectionId }}>
  // Get all elements using the dynamic sectionId
  const searchInput = document.getElementById(`${sectionId}-search-input`);
  const clearButton = document.getElementById(`${sectionId}-clear-search`);
  const resultsCount = document.getElementById(`${sectionId}-results-count`);
  const resultsContainer = document.querySelector(`[data-section-id="${sectionId}"] .section-content`);
  const noResults = document.getElementById(`${sectionId}-no-results`);
  const tagPills = document.querySelectorAll(`.tag-pill[data-section="${sectionId}"]`);
  const postItems = document.querySelectorAll(`.post-item[data-section="${sectionId}"]`);
  const toggleTagsButton = document.getElementById(`${sectionId}-toggle-tags`);
  const tagPillsWrapper = document.getElementById(`${sectionId}-tag-pills-wrapper`);
  
  let activeTag = 'all';
  let searchQuery = '';
  let showAllPosts = false;
  let tagsExpanded = false;
  
  // Update results based on filters
  function updateResults() {
    let visibleCount = 0;
    let matchingPosts = 0;
    
    postItems.forEach((item, index) => {
      const tags = JSON.parse(item.dataset.tags || '[]');
      const postData = JSON.parse(item.dataset.postData || '{}');
      
      // Check tag filter
      const matchesTag = activeTag === 'all' || tags.includes(activeTag);
      
      // Check search query
      const matchesSearch = !searchQuery || 
        postData.title?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        postData.description?.toLowerCase().includes(searchQuery.toLowerCase());
      
      const matchesFilters = matchesTag && matchesSearch;
      
      if (matchesFilters) {
        matchingPosts++;
        // Show post if it's within limit or if showing all
        if (showAllPosts || matchingPosts <= MAX_POSTS) {
          item.classList.remove('hidden');
          item.style.display = '';
          visibleCount++;
        } else {
          item.classList.add('hidden');
          item.style.display = 'none';
        }
      } else {
        item.classList.add('hidden');
        item.style.display = 'none';
      }
    });
    
    // Update results count
    if (searchQuery || activeTag !== 'all') {
      resultsCount.textContent = `Showing ${visibleCount} post${visibleCount !== 1 ? 's' : ''}`;
    } else {
      const totalPosts = postItems.length;
      resultsCount.textContent = `Showing ${visibleCount} of ${totalPosts} posts`;
    }
    
    // Show/hide no results message
    if (visibleCount === 0) {
      resultsContainer.style.display = 'none';
      noResults.style.display = 'block';
    } else {
      resultsContainer.style.display = '';
      noResults.style.display = 'none';
    }
  }
  
  // Handle search input
  searchInput.addEventListener('input', (e) => {
    searchQuery = e.target.value.trim();
    
    // Show/hide clear button
    if (searchQuery) {
      clearButton.classList.add('visible');
      showAllPosts = true; // Show all matching results when searching
    } else {
      clearButton.classList.remove('visible');
      showAllPosts = false; // Reset to limited view when search is cleared
    }
    
    updateResults();
  });
  
  // Handle clear button
  clearButton.addEventListener('click', () => {
    searchInput.value = '';
    searchQuery = '';
    showAllPosts = false;
    clearButton.classList.remove('visible');
    updateResults();
  });
  
  // Handle tag pills
  tagPills.forEach((pill) => {
    pill.addEventListener('click', (e) => {
      const button = e.target;
      activeTag = button.dataset.tag || 'all';
      
      // Update active state
      tagPills.forEach((p) => p.classList.remove('active'));
      button.classList.add('active');
      
      // Show all posts when filtering by tag
      if (activeTag !== 'all') {
        showAllPosts = true;
      } else if (!searchQuery) {
        showAllPosts = false;
      }
      
      updateResults();
    });
  });
  
  // Handle toggle tags button
  if (toggleTagsButton && tagPillsWrapper) {
    toggleTagsButton.addEventListener('click', () => {
      tagsExpanded = !tagsExpanded;
      if (tagsExpanded) {
        tagPillsWrapper.style.maxHeight = 'none';
        toggleTagsButton.textContent = 'Show Less Tags ▲';
      } else {
        tagPillsWrapper.style.maxHeight = '2.5rem';
        toggleTagsButton.textContent = 'Show More Tags ▼';
      }
    });
  }
</script>
